{"version":3,"sources":["../../../../src/snaps/endowments/name-lookup.ts"],"sourcesContent":["import type {\n  EndowmentGetterParams,\n  PermissionSpecificationBuilder,\n  PermissionValidatorConstraint,\n  ValidPermissionSpecification,\n  Caveat,\n  CaveatSpecificationConstraint,\n  PermissionConstraint,\n} from '@metamask/permission-controller';\nimport { PermissionType, SubjectType } from '@metamask/permission-controller';\nimport { rpcErrors } from '@metamask/rpc-errors';\nimport { SnapCaveatType, isChainId } from '@metamask/snaps-utils';\nimport type { Json, NonEmptyArray } from '@metamask/utils';\nimport { assert, hasProperty, isPlainObject } from '@metamask/utils';\n\nimport { SnapEndowments } from './enum';\n\nconst permissionName = SnapEndowments.NameLookup;\n\ntype NameLookupEndowmentSpecification = ValidPermissionSpecification<{\n  permissionType: PermissionType.Endowment;\n  targetName: typeof permissionName;\n  endowmentGetter: (_options?: EndowmentGetterParams) => undefined;\n  allowedCaveats: Readonly<NonEmptyArray<string>> | null;\n  validator: PermissionValidatorConstraint;\n}>;\n\n/**\n * `endowment:name-lookup` returns nothing; it is intended to be used as a flag\n * by the extension to detect whether the snap has the capability to resolve a domain/address.\n *\n * @param _builderOptions - Optional specification builder options.\n * @returns The specification for the name-lookup endowment.\n */\nconst specificationBuilder: PermissionSpecificationBuilder<\n  PermissionType.Endowment,\n  any,\n  NameLookupEndowmentSpecification\n> = (_builderOptions?: unknown) => {\n  return {\n    permissionType: PermissionType.Endowment,\n    targetName: permissionName,\n    allowedCaveats: [SnapCaveatType.ChainIds],\n    endowmentGetter: (_getterOptions?: EndowmentGetterParams) => undefined,\n    validator: ({ caveats }) => {\n      if (\n        !caveats ||\n        (caveats !== null && caveats?.length > 1) ||\n        (caveats?.length === 1 && caveats[0].type !== SnapCaveatType.ChainIds)\n      ) {\n        throw rpcErrors.invalidParams({\n          message: `Expected a single \"${SnapCaveatType.ChainIds}\" caveat.`,\n        });\n      }\n    },\n    subjectTypes: [SubjectType.Snap],\n  };\n};\n\nexport const nameLookupEndowmentBuilder = Object.freeze({\n  targetName: permissionName,\n  specificationBuilder,\n} as const);\n\n/**\n * Validates the type of the caveat value.\n *\n * @param caveat - The caveat to validate.\n * @throws If the caveat value is invalid.\n */\nfunction validateCaveat(caveat: Caveat<string, any>): void {\n  if (!hasProperty(caveat, 'value') || !isPlainObject(caveat)) {\n    throw rpcErrors.invalidParams({\n      message: 'Expected a plain object.',\n    });\n  }\n\n  const { value } = caveat;\n\n  assert(\n    Array.isArray(value) && value.every((val) => isChainId(val)),\n    'Expected caveat value to have type \"string array\"',\n  );\n}\n\n/**\n * Map a raw value from the `initialPermissions` to a caveat specification.\n * Note that this function does not do any validation, that's handled by the\n * PermissionsController when the permission is requested.\n *\n * @param value - The raw value from the `initialPermissions`.\n * @returns The caveat specification.\n */\nexport function getNameLookupCaveatMapper(\n  value: Json,\n): Pick<PermissionConstraint, 'caveats'> {\n  if (\n    !value ||\n    !Array.isArray(value) ||\n    (Array.isArray(value) && value.length === 0)\n  ) {\n    return { caveats: null };\n  }\n  return {\n    caveats: [\n      {\n        type: SnapCaveatType.ChainIds,\n        value,\n      },\n    ],\n  };\n}\n\n/**\n * Getter function to get the chainIds caveat from a permission.\n *\n * This does basic validation of the caveat, but does not validate the type or\n * value of the namespaces object itself, as this is handled by the\n * `PermissionsController` when the permission is requested.\n *\n * @param permission - The permission to get the `chainIds` caveat from.\n * @returns An array of `chainIds` that the snap supports.\n */\nexport function getChainIdsCaveat(\n  permission?: PermissionConstraint,\n): string[] | null {\n  if (!permission?.caveats) {\n    return null;\n  }\n\n  assert(permission.caveats.length === 1);\n  assert(permission.caveats[0].type === SnapCaveatType.ChainIds);\n\n  const caveat = permission.caveats[0] as Caveat<string, string[]>;\n\n  return caveat.value ?? null;\n}\n\nexport const nameLookupCaveatSpecifications: Record<\n  SnapCaveatType.ChainIds,\n  CaveatSpecificationConstraint\n> = {\n  [SnapCaveatType.ChainIds]: Object.freeze({\n    type: SnapCaveatType.ChainIds,\n    validator: (caveat: Caveat<string, any>) => validateCaveat(caveat),\n  }),\n};\n"],"names":["PermissionType","SubjectType","rpcErrors","SnapCaveatType","isChainId","assert","hasProperty","isPlainObject","SnapEndowments","permissionName","NameLookup","specificationBuilder","_builderOptions","permissionType","Endowment","targetName","allowedCaveats","ChainIds","endowmentGetter","_getterOptions","undefined","validator","caveats","length","type","invalidParams","message","subjectTypes","Snap","nameLookupEndowmentBuilder","Object","freeze","validateCaveat","caveat","value","Array","isArray","every","val","getNameLookupCaveatMapper","getChainIdsCaveat","permission","nameLookupCaveatSpecifications"],"mappings":"AASA,SAASA,cAAc,EAAEC,WAAW,QAAQ,kCAAkC;AAC9E,SAASC,SAAS,QAAQ,uBAAuB;AACjD,SAASC,cAAc,EAAEC,SAAS,QAAQ,wBAAwB;AAElE,SAASC,MAAM,EAAEC,WAAW,EAAEC,aAAa,QAAQ,kBAAkB;AAErE,SAASC,cAAc,QAAQ,SAAS;AAExC,MAAMC,iBAAiBD,eAAeE,UAAU;AAUhD;;;;;;CAMC,GACD,MAAMC,uBAIF,CAACC;IACH,OAAO;QACLC,gBAAgBb,eAAec,SAAS;QACxCC,YAAYN;QACZO,gBAAgB;YAACb,eAAec,QAAQ;SAAC;QACzCC,iBAAiB,CAACC,iBAA2CC;QAC7DC,WAAW,CAAC,EAAEC,OAAO,EAAE;YACrB,IACE,CAACA,WACAA,YAAY,QAAQA,SAASC,SAAS,KACtCD,SAASC,WAAW,KAAKD,OAAO,CAAC,EAAE,CAACE,IAAI,KAAKrB,eAAec,QAAQ,EACrE;gBACA,MAAMf,UAAUuB,aAAa,CAAC;oBAC5BC,SAAS,CAAC,mBAAmB,EAAEvB,eAAec,QAAQ,CAAC,SAAS,CAAC;gBACnE;YACF;QACF;QACAU,cAAc;YAAC1B,YAAY2B,IAAI;SAAC;IAClC;AACF;AAEA,OAAO,MAAMC,6BAA6BC,OAAOC,MAAM,CAAC;IACtDhB,YAAYN;IACZE;AACF,GAAY;AAEZ;;;;;CAKC,GACD,SAASqB,eAAeC,MAA2B;IACjD,IAAI,CAAC3B,YAAY2B,QAAQ,YAAY,CAAC1B,cAAc0B,SAAS;QAC3D,MAAM/B,UAAUuB,aAAa,CAAC;YAC5BC,SAAS;QACX;IACF;IAEA,MAAM,EAAEQ,KAAK,EAAE,GAAGD;IAElB5B,OACE8B,MAAMC,OAAO,CAACF,UAAUA,MAAMG,KAAK,CAAC,CAACC,MAAQlC,UAAUkC,OACvD;AAEJ;AAEA;;;;;;;CAOC,GACD,OAAO,SAASC,0BACdL,KAAW;IAEX,IACE,CAACA,SACD,CAACC,MAAMC,OAAO,CAACF,UACdC,MAAMC,OAAO,CAACF,UAAUA,MAAMX,MAAM,KAAK,GAC1C;QACA,OAAO;YAAED,SAAS;QAAK;IACzB;IACA,OAAO;QACLA,SAAS;YACP;gBACEE,MAAMrB,eAAec,QAAQ;gBAC7BiB;YACF;SACD;IACH;AACF;AAEA;;;;;;;;;CASC,GACD,OAAO,SAASM,kBACdC,UAAiC;IAEjC,IAAI,CAACA,YAAYnB,SAAS;QACxB,OAAO;IACT;IAEAjB,OAAOoC,WAAWnB,OAAO,CAACC,MAAM,KAAK;IACrClB,OAAOoC,WAAWnB,OAAO,CAAC,EAAE,CAACE,IAAI,KAAKrB,eAAec,QAAQ;IAE7D,MAAMgB,SAASQ,WAAWnB,OAAO,CAAC,EAAE;IAEpC,OAAOW,OAAOC,KAAK,IAAI;AACzB;AAEA,OAAO,MAAMQ,iCAGT;IACF,CAACvC,eAAec,QAAQ,CAAC,EAAEa,OAAOC,MAAM,CAAC;QACvCP,MAAMrB,eAAec,QAAQ;QAC7BI,WAAW,CAACY,SAAgCD,eAAeC;IAC7D;AACF,EAAE"}