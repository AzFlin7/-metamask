{"version":3,"file":"LoggingController.js","sourceRoot":"","sources":["../src/LoggingController.ts"],"names":[],"mappings":";;;;;;;;;AACA,+DAA2D;AAC3D,+BAAoC;AA0BpC,MAAM,IAAI,GAAG,mBAAmB,CAAC;AAwBjC,MAAM,QAAQ,GAAG;IACf,IAAI,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE,KAAK,EAAE;CAC1C,CAAC;AAEF,MAAM,YAAY,GAAG;IACnB,IAAI,EAAE,EAAE;CACT,CAAC;AAEF;;GAEG;AACH,MAAa,iBAAkB,SAAQ,gCAItC;IACC;;;;;;OAMG;IACH,YAAY,EACV,SAAS,EACT,KAAK,GAIN;QACC,KAAK,CAAC;YACJ,IAAI;YACJ,QAAQ;YACR,SAAS;YACT,KAAK,kCACA,YAAY,GACZ,KAAK,CACT;SACF,CAAC,CAAC;;QAEH,IAAI,CAAC,eAAe,CAAC,qBAAqB,CACxC,GAAG,IAAI,MAAe,EACtB,CAAC,GAAQ,EAAE,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,CAC5B,CAAC;IACJ,CAAC;IAmBD;;;;OAIG;IACH,GAAG,CAAC,GAAQ;QACV,MAAM,MAAM,GAAa;YACvB,EAAE,EAAE,uBAAA,IAAI,mEAAY,MAAhB,IAAI,CAAc;YACtB,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;YACrB,GAAG;SACJ,CAAC;QAEF,IAAI,CAAC,MAAM,CAAC,CAAC,KAAK,EAAE,EAAE;YACpB,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,GAAG,MAAM,CAAC;QACjC,CAAC,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,KAAK;QACH,IAAI,CAAC,MAAM,CAAC,CAAC,KAAK,EAAE,EAAE;YACpB,KAAK,CAAC,IAAI,GAAG,EAAE,CAAC;QAClB,CAAC,CAAC,CAAC;IACL,CAAC;CACF;AA7ED,8CA6EC;;IAhCG,IAAI,EAAE,GAAG,IAAA,SAAM,GAAE,CAAC;IAClB,OAAO,EAAE,IAAI,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE;QAC5B,EAAE,GAAG,IAAA,SAAM,GAAE,CAAC;KACf;IACD,OAAO,EAAE,CAAC;AACZ,CAAC","sourcesContent":["import type { RestrictedControllerMessenger } from '@metamask/base-controller';\nimport { BaseController } from '@metamask/base-controller';\nimport { v1 as random } from 'uuid';\n\nimport type { Log } from './logTypes';\n\n/**\n * LogEntry is the entry that will be added to the logging controller state.\n * It consists of a entry key that must be on of the Log union types, and an\n * additional id and timestamp.\n */\nexport type LogEntry = {\n  id: string;\n  timestamp: number;\n  log: Log;\n};\n\n/**\n * Logging controller state\n *\n * @property logs - An object of logs indexed by their ids\n */\nexport type LoggingControllerState = {\n  logs: {\n    [id: string]: LogEntry;\n  };\n};\n\nconst name = 'LoggingController';\n\n/**\n * An action to add log messages to the controller state.\n */\nexport type AddLog = {\n  type: `${typeof name}:add`;\n  handler: LoggingController['add'];\n};\n\n/**\n * Currently only an alias, but the idea here is if future actions are needed\n * this can transition easily into a union type.\n */\nexport type LoggingControllerActions = AddLog;\n\nexport type LoggingControllerMessenger = RestrictedControllerMessenger<\n  typeof name,\n  LoggingControllerActions,\n  never,\n  never,\n  never\n>;\n\nconst metadata = {\n  logs: { persist: true, anonymous: false },\n};\n\nconst defaultState = {\n  logs: {},\n};\n\n/**\n * Controller that manages a list of logs for signature requests.\n */\nexport class LoggingController extends BaseController<\n  typeof name,\n  LoggingControllerState,\n  LoggingControllerMessenger\n> {\n  /**\n   * Creates a LoggingController instance.\n   *\n   * @param options - Constructor options\n   * @param options.messenger - An instance of the ControllerMessenger\n   * @param options.state - Initial state to set on this controller.\n   */\n  constructor({\n    messenger,\n    state,\n  }: {\n    messenger: LoggingControllerMessenger;\n    state?: Partial<LoggingControllerState>;\n  }) {\n    super({\n      name,\n      metadata,\n      messenger,\n      state: {\n        ...defaultState,\n        ...state,\n      },\n    });\n\n    this.messagingSystem.registerActionHandler(\n      `${name}:add` as const,\n      (log: Log) => this.add(log),\n    );\n  }\n\n  /**\n   * Method to generate a randomId and ensures no collision with existing ids.\n   *\n   * We may want to end up using a hashing mechanism to make ids deterministic\n   * by the *data* passed in, and then make each key an array of logs that\n   * match that id.\n   *\n   * @returns unique id\n   */\n  #generateId(): string {\n    let id = random();\n    while (id in this.state.logs) {\n      id = random();\n    }\n    return id;\n  }\n\n  /**\n   * Add log to the state.\n   *\n   * @param log - Log to add to the controller\n   */\n  add(log: Log) {\n    const newLog: LogEntry = {\n      id: this.#generateId(),\n      timestamp: Date.now(),\n      log,\n    };\n\n    this.update((state) => {\n      state.logs[newLog.id] = newLog;\n    });\n  }\n\n  /**\n   * Removes all log entries.\n   */\n  clear() {\n    this.update((state) => {\n      state.logs = {};\n    });\n  }\n}\n"]}