{"version":3,"sources":["../../../src/permitted/middleware.ts"],"sourcesContent":["import type { JsonRpcMiddleware } from '@metamask/json-rpc-engine';\nimport { rpcErrors } from '@metamask/rpc-errors';\nimport { logError } from '@metamask/snaps-utils';\nimport type { Json, JsonRpcParams } from '@metamask/utils';\n\nimport { selectHooks } from '../utils';\nimport { methodHandlers } from './handlers';\n\n/**\n * Creates a middleware that handles permitted snap RPC methods.\n *\n * @param isSnap - A flag that should indicate whether the requesting origin is a snap or not.\n * @param hooks - An object containing the hooks made available to the permitted RPC methods.\n * @returns The middleware.\n */\nexport function createSnapsMethodMiddleware(\n  isSnap: boolean,\n  hooks: Record<string, unknown>,\n): JsonRpcMiddleware<JsonRpcParams, Json> {\n  // This is not actually a misused promise, the type is just wrong\n  // eslint-disable-next-line @typescript-eslint/no-misused-promises\n  return async function methodMiddleware(request, response, next, end) {\n    const handler =\n      methodHandlers[request.method as keyof typeof methodHandlers];\n    if (handler) {\n      if (\n        String.prototype.startsWith.call(request.method, 'snap_') &&\n        !isSnap\n      ) {\n        return end(rpcErrors.methodNotFound());\n      }\n\n      // TODO: Once json-rpc-engine types are up to date, we should type this correctly\n      const { implementation, hookNames } = handler as any;\n      try {\n        // Implementations may or may not be async, so we must await them.\n        return await implementation(\n          request,\n          response,\n          next,\n          end,\n          selectHooks(hooks, hookNames),\n        );\n      } catch (error) {\n        logError(error);\n        return end(error);\n      }\n    }\n\n    return next();\n  };\n}\n"],"names":["rpcErrors","logError","selectHooks","methodHandlers","createSnapsMethodMiddleware","isSnap","hooks","methodMiddleware","request","response","next","end","handler","method","String","prototype","startsWith","call","methodNotFound","implementation","hookNames","error"],"mappings":"AACA,SAASA,SAAS,QAAQ,uBAAuB;AACjD,SAASC,QAAQ,QAAQ,wBAAwB;AAGjD,SAASC,WAAW,QAAQ,WAAW;AACvC,SAASC,cAAc,QAAQ,aAAa;AAE5C;;;;;;CAMC,GACD,OAAO,SAASC,4BACdC,MAAe,EACfC,KAA8B;IAE9B,iEAAiE;IACjE,kEAAkE;IAClE,OAAO,eAAeC,iBAAiBC,OAAO,EAAEC,QAAQ,EAAEC,IAAI,EAAEC,GAAG;QACjE,MAAMC,UACJT,cAAc,CAACK,QAAQK,MAAM,CAAgC;QAC/D,IAAID,SAAS;YACX,IACEE,OAAOC,SAAS,CAACC,UAAU,CAACC,IAAI,CAACT,QAAQK,MAAM,EAAE,YACjD,CAACR,QACD;gBACA,OAAOM,IAAIX,UAAUkB,cAAc;YACrC;YAEA,iFAAiF;YACjF,MAAM,EAAEC,cAAc,EAAEC,SAAS,EAAE,GAAGR;YACtC,IAAI;gBACF,kEAAkE;gBAClE,OAAO,MAAMO,eACXX,SACAC,UACAC,MACAC,KACAT,YAAYI,OAAOc;YAEvB,EAAE,OAAOC,OAAO;gBACdpB,SAASoB;gBACT,OAAOV,IAAIU;YACb;QACF;QAEA,OAAOX;IACT;AACF"}